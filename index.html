<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA Configuration -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Security Pro">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0a2540">
    
    <!-- App Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect fill='%230a2540' width='180' height='180' rx='40'/%3E%3Ctext y='130' x='90' text-anchor='middle' font-size='100' fill='white'%3Eüõ°Ô∏è%3C/text%3E%3C/svg%3E">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='75' x='50' text-anchor='middle' font-size='80'%3Eüõ°Ô∏è%3C/text%3E%3C/svg%3E">
    
    <title>Security Assessment Pro</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #0a2540;
            --primary-light: #1a3a5f;
            --accent: #00d4ff;
            --success: #00c896;
            --warning: #ffb020;
            --danger: #ff4757;
            --bg: #f8fafc;
            --card: #ffffff;
            --border: #e2e8f0;
            --text: #1e293b;
            --text-light: #64748b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            overflow-x: hidden;
            padding-bottom: 140px;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: max(env(safe-area-inset-top, 20px), 20px) 20px 20px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .header h1 {
            font-size: 1.6rem;
            font-weight: 800;
            margin-bottom: 6px;
        }

        .header p {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-bottom: 12px;
        }

        .install-banner {
            background: rgba(0, 212, 255, 0.15);
            padding: 10px 12px;
            border-radius: 8px;
            border: 1.5px solid var(--accent);
            font-size: 0.8rem;
            display: none;
            margin-top: 10px;
        }

        .install-banner.show {
            display: block;
        }

        .install-banner strong {
            display: block;
            margin-bottom: 4px;
        }

        .progress-wrapper {
            margin-top: 12px;
        }

        .progress-bar {
            background: rgba(255,255,255,0.2);
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            background: var(--accent);
            height: 100%;
            width: 0%;
            transition: width 0.4s ease;
            box-shadow: 0 0 10px rgba(0,212,255,0.6);
        }

        .progress-text {
            font-size: 0.75rem;
            margin-top: 6px;
            opacity: 0.95;
        }

        .tabs {
            background: white;
            padding: 12px 0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            white-space: nowrap;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 99;
        }

        .tab {
            display: inline-block;
            padding: 10px 18px;
            margin: 0 4px;
            background: var(--bg);
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-light);
            border: 2px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .content {
            padding: 16px;
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .section-desc {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 20px;
        }

        .subsection {
            font-size: 1.05rem;
            font-weight: 600;
            color: var(--primary);
            margin: 24px 0 12px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            background: white;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0,212,255,0.1);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border: 2px solid var(--border);
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .question {
            font-weight: 600;
            margin-bottom: 12px;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .toggle-btns {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .toggle-btn {
            padding: 14px 8px;
            border: 2px solid var(--border);
            background: white;
            border-radius: 10px;
            font-weight: 700;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .toggle-btn:active {
            transform: scale(0.97);
        }

        .toggle-btn.yes.active {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .toggle-btn.partial.active {
            background: var(--warning);
            border-color: var(--warning);
            color: white;
        }

        .toggle-btn.no.active {
            background: var(--danger);
            border-color: var(--danger);
            color: white;
        }

        .rec {
            margin-top: 12px;
            padding: 12px;
            background: var(--bg);
            border-radius: 8px;
            border-left: 4px solid var(--accent);
            font-size: 0.85rem;
            line-height: 1.6;
            display: none;
        }

        .rec.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 8px;
            letter-spacing: 0.3px;
        }

        .badge-critical { background: #fee; color: #c00; }
        .badge-important { background: #fff4e6; color: #d97706; }
        .badge-good { background: #d1fae5; color: #065f46; }

        .notes {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            min-height: 70px;
            margin-top: 12px;
            resize: vertical;
        }

        .notes:focus {
            outline: none;
            border-color: var(--accent);
        }

        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 12px 16px;
            padding-bottom: max(env(safe-area-inset-bottom, 12px), 12px);
            border-top: 1px solid var(--border);
            box-shadow: 0 -4px 12px rgba(0,0,0,0.08);
            z-index: 100;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-bottom: 10px;
        }

        .stat {
            text-align: center;
            padding: 6px;
            background: var(--bg);
            border-radius: 8px;
        }

        .stat-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.65rem;
            color: var(--text-light);
            text-transform: uppercase;
            margin-top: 2px;
        }

        .btn-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .btn {
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--success);
            color: white;
            box-shadow: 0 4px 12px rgba(0,200,150,0.25);
        }

        .btn-secondary {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(10,37,64,0.25);
        }

        .btn:disabled {
            opacity: 0.5;
        }

        .toast {
            position: fixed;
            bottom: 140px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 0.85rem;
            display: none;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .toast.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-50%) translateY(10px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        @media (min-width: 768px) {
            .content {
                max-width: 800px;
                margin: 0 auto;
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>
    <div id="toast" class="toast"></div>

    <script>
        // Data storage with localStorage
        let data = JSON.parse(localStorage.getItem('securityAssessment') || '{}');
        let currentTab = 'property';

        // Assessment configuration
        const sections = {
            property: {
                title: 'üè† Property Info',
                desc: 'Basic property and threat information',
                fields: [
                    { id: 'propName', label: 'Property Name/Identifier', type: 'text' },
                    { id: 'address', label: 'Address/Location', type: 'text' },
                    { id: 'sqft', label: 'Square Footage', type: 'text' },
                    { id: 'threat', label: 'Threat Level', type: 'select', 
                      options: ['Low (Private)', 'Medium (Regional)', 'High (National)', 'Critical (High-risk)'] }
                ]
            },
            perimeter: {
                title: 'üõ°Ô∏è Perimeter',
                desc: 'Boundaries and access control',
                items: [
                    {
                        id: 'p1',
                        q: 'Property boundaries clearly defined with permanent barriers',
                        r: {
                            yes: { s: 'good', t: 'Perimeter boundaries adequate. Maintain quarterly inspections for damage.' },
                            partial: { s: 'important', t: 'UPGRADE: Complete perimeter barrier gaps and add anti-climb features to vulnerable sections.' },
                            no: { s: 'critical', t: 'IMMEDIATE ACTION: Install perimeter fencing minimum 6ft height with anti-climb features. Estimated cost: $50-150/linear foot.' }
                        }
                    },
                    {
                        id: 'p2',
                        q: 'Anti-climb features installed (wall toppers, anti-scale coating, security spikes)',
                        r: {
                            yes: { s: 'good', t: 'Anti-climb features in place. Inspect annually for damage and after storms.' },
                            partial: { s: 'important', t: 'Complete anti-climb protection on all perimeter sections, especially near access points and neighboring properties.' },
                            no: { s: 'critical', t: 'CRITICAL VULNERABILITY: Add anti-climb deterrents immediately. Rotating wall toppers ($15-30/ft) or security spikes ($10-25/ft). Priority for areas near trees.' }
                        }
                    },
                    {
                        id: 'p3',
                        q: 'Adequate standoff distance from public road (minimum 30ft recommended)',
                        r: {
                            yes: { s: 'good', t: 'Standoff distance adequate. Consider additional speed control measures (speed bumps, narrowing) for enhanced security.' },
                            partial: { s: 'important', t: 'Enhance standoff protection with bollards, serpentine driveway design, or landscaping barriers to slow vehicle approach.' },
                            no: { s: 'critical', t: 'MAJOR VULNERABILITY: Insufficient standoff increases vehicle ramming risk. Add bollards at entry ($200-500 each) or crash-rated barriers.' }
                        }
                    },
                    {
                        id: 'p4',
                        q: 'All vehicle entries gated/controlled (automated gates with intercom/camera)',
                        r: {
                            yes: { s: 'good', t: 'Gate controls adequate. Recommendation: Enable access logging and implement visitor pre-authorization system via mobile app.' },
                            partial: { s: 'important', t: 'Upgrade gate controls: Add video intercom if missing, implement access logging, consider LPR integration for automated entry management.' },
                            no: { s: 'critical', t: 'IMMEDIATE PRIORITY: Install automated gate system with camera intercom. Minimum: Slide gate with keypad/remote ($3,000-8,000). Enhanced: Add LPR system ($2,000-5,000).' }
                        }
                    },
                    {
                        id: 'p5',
                        q: 'All approaches, entry points, and perimeter adequately lit (minimum 5 foot-candles)',
                        r: {
                            yes: { s: 'good', t: 'Lighting coverage adequate. Recommendation: Upgrade to smart lighting with remote monitoring and automated schedules.' },
                            partial: { s: 'important', t: 'Eliminate all dark zones. Add motion-activated LED floods at identified gaps. Test lighting monthly, replace failed fixtures within 24 hours.' },
                            no: { s: 'critical', t: 'CRITICAL VULNERABILITY: Dark zones enable concealed approach. Install LED lighting: Perimeter floods ($50-200 each), pathway lights ($30-100 each). Motion-activation recommended. Total estimate: $2,000-8,000.' }
                        }
                    },
                    {
                        id: 'p6',
                        q: 'Bushes/shrubs trimmed below 3 feet near windows and walkways',
                        r: {
                            yes: { s: 'good', t: 'CPTED landscaping maintained. Continue quarterly trimming schedule and document compliance with photos.' },
                            partial: { s: 'important', t: 'Complete landscaping compliance. Create formal maintenance schedule with photo documentation of proper clearance zones. Train crew on security requirements.' },
                            no: { s: 'important', t: 'IMMEDIATE ACTION: Trim all vegetation below windows to 3ft maximum. CPTED standard: Clear sightlines, eliminate concealment. Professional landscaping: $500-2,000 initial, $200-500 quarterly.' }
                        }
                    }
                ]
            },
            building: {
                title: 'üèóÔ∏è Building',
                desc: 'Doors, windows, and structural protection',
                items: [
                    {
                        id: 'b1',
                        q: 'All exterior doors solid-core or steel (minimum 1¬æ" thick, 18-gauge steel)',
                        r: {
                            yes: { s: 'good', t: 'Door construction adequate. Verify hinges and strikes are properly reinforced with 3" screws into studs.' },
                            partial: { s: 'important', t: 'Replace remaining hollow-core doors. All exterior doors must be solid-core minimum. Consider steel upgrade for highest security.' },
                            no: { s: 'critical', t: 'CRITICAL VULNERABILITY: Replace hollow-core doors immediately. Steel doors: $300-1,000 each installed. Solid wood: $400-1,500. Prioritize primary entry and bedroom access doors.' }
                        }
                    },
                    {
                        id: 'b2',
                        q: 'Grade 1 deadbolts installed on all exterior doors (ANSI/BHMA certified)',
                        r: {
                            yes: { s: 'good', t: 'Grade 1 locks installed. Recommendation: Implement key control program and consider upgrade to smart locks with activity logging.' },
                            partial: { s: 'important', t: 'Upgrade all locks to Grade 1 ANSI/BHMA certified. Replace builder-grade locks immediately. Add anti-bump, anti-drill, anti-pick features.' },
                            no: { s: 'critical', t: 'IMMEDIATE ACTION: Install Grade 1 deadbolts on all exterior doors. Minimum: Schlage B60N or Kwikset 980 ($50-100 each). Enhanced: Smart locks with Grade 1 rating ($200-400). Must have 1" throw minimum.' }
                        }
                    },
                    {
                        id: 'b3',
                        q: 'Door frames reinforced (steel jambs or hardwood with steel strike plates)',
                        r: {
                            yes: { s: 'good', t: 'Frame reinforcement adequate. Inspect annually for wood rot, screw loosening, or frame separation.' },
                            partial: { s: 'important', t: 'Complete frame reinforcement on all exterior doors. Ensure all strike plate screws penetrate studs, not just jamb. Replace short screws.' },
                            no: { s: 'critical', t: 'CRITICAL WEAKNESS: Frames are the weakest point. Install 18-gauge steel strike plates with 3" screws into wall studs. Door armor kits: $40-150 per door. Essential for kick-resistance.' }
                        }
                    },
                    {
                        id: 'b4',
                        q: 'Ground-level windows reinforced (security film minimum 8mil, laminated glass, or bars)',
                        r: {
                            yes: { s: 'good', t: 'Window reinforcement in place. Security film should be replaced every 10-15 years or after impact damage.' },
                            partial: { s: 'important', t: 'Complete window reinforcement on all ground-floor and accessible windows. Verify film is anchored to frame with wet-glaze system.' },
                            no: { s: 'critical', t: 'CRITICAL VULNERABILITY: Windows are primary entry point. Install 8-12mil security film ($7-15/sq ft installed) or laminated glass ($40-100/sq ft). For high-threat: Consider bars or grilles ($200-800 per window).' }
                        }
                    },
                    {
                        id: 'b5',
                        q: 'Sliding glass doors secured (blocking bar, foot lock, anti-lift plates installed)',
                        r: {
                            yes: { s: 'good', t: 'Sliding door security adequate. Verify all devices functional and blocking bar is used when occupied.' },
                            partial: { s: 'important', t: 'Install missing security devices. All sliding doors require: blocking bar, additional lock, and anti-lift plates. Verify track cannot be lifted.' },
                            no: { s: 'critical', t: 'CRITICAL WEAKNESS: Sliding doors easily lifted/forced. Install: Blocking bar ($20-50), foot lock ($15-40), and anti-lift plates ($10-30). All three recommended for maximum security.' }
                        }
                    }
                ]
            },
            systems: {
                title: 'üìπ Systems',
                desc: 'Cameras, alarms, and technology',
                items: [
                    {
                        id: 's1',
                        q: 'Cameras cover all exterior approaches with no critical blind spots',
                        r: {
                            yes: { s: 'good', t: 'Camera coverage adequate. Recommendation: Add AI analytics (person/vehicle detection), LPR at gate, thermal cameras for complete darkness.' },
                            partial: { s: 'important', t: 'Eliminate blind spots. Add cameras at identified gaps. Verify overlapping coverage at all entry points. No approach should be unmonitored.' },
                            no: { s: 'critical', t: 'MAJOR VULNERABILITY: Install comprehensive camera system. Minimum: 4-8 cameras for typical residence. 4K cameras ($150-400 each), NVR ($300-800), installation ($1,000-3,000). Coverage needed: All entries, driveway, perimeter, garage.' }
                        }
                    },
                    {
                        id: 's2',
                        q: '4K/high-resolution cameras with night vision (IR/thermal/low-light)',
                        r: {
                            yes: { s: 'good', t: 'High-quality cameras deployed. Maintain: Clean lenses quarterly, verify night vision function, update firmware regularly.' },
                            partial: { s: 'important', t: 'Upgrade remaining low-resolution cameras to 4K. Verify all cameras have adequate night vision - IR minimum, thermal preferred for perimeter coverage.' },
                            no: { s: 'important', t: 'UPGRADE NEEDED: Replace analog or low-res cameras with 4K IP cameras. Modern cameras essential for identification. Budget: $200-500 per camera. IR night vision required - thermal recommended for perimeter ($800-2,000).' }
                        }
                    },
                    {
                        id: 's3',
                        q: 'Professional 24/7 alarm monitoring active',
                        r: {
                            yes: { s: 'good', t: 'Professional monitoring active. Verify: Current police authorization, contact list updated, monthly test calls, response time acceptable (under 2 minutes to dispatch).' },
                            partial: { s: 'important', t: 'Ensure monitoring includes: Police dispatch authorization, cellular backup, redundant communication path. Verify response protocol with monitoring company quarterly.' },
                            no: { s: 'critical', t: 'CRITICAL VULNERABILITY: Self-monitored systems require your response. Professional monitoring essential: $30-60/month. Provides: Police dispatch, fire/medical response, redundant communication. For high-threat profiles: Mandatory.' }
                        }
                    },
                    {
                        id: 's4',
                        q: 'All exterior doors and accessible windows sensored (integrated with alarm)',
                        r: {
                            yes: { s: 'good', t: 'Perimeter protection complete. Test all sensors monthly. Replace wireless sensor batteries annually. Verify monitoring station receives all signals.' },
                            partial: { s: 'important', t: 'Complete perimeter sensor coverage. EVERY door and accessible window must be sensored. Verify system reports sensor status (open/closed).' },
                            no: { s: 'critical', t: 'CRITICAL SYSTEM GAP: Install complete alarm system with sensors on all doors and accessible windows. Professional system: $500-2,000 equipment + $30-60/month monitoring. Self-monitored: $300-800 equipment. Mandatory for adequate security.' }
                        }
                    },
                    {
                        id: 's5',
                        q: 'Cellular/IP backup communication (in case of line cut or internet failure)',
                        r: {
                            yes: { s: 'good', t: 'Backup communication in place. Test monthly by disconnecting primary path. Verify monitoring station receives signal via backup within 30-60 seconds.' },
                            partial: { s: 'important', t: 'Verify cellular backup functional and active. Test monthly by disconnecting primary communication. Alarm must still report to monitoring station.' },
                            no: { s: 'critical', t: 'CRITICAL VULNERABILITY: Phone/internet lines can be cut. Add cellular backup: $10-20/month. Essential for alarm signal transmission if primary communication fails. Mandatory for professional systems.' }
                        }
                    }
                ]
            }
        };

        // Initialize app
        function init() {
            checkStandalone();
            render();
            updateStats();
        }

        // Check if running as installed PWA
        function checkStandalone() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                                window.navigator.standalone === true;
            
            if (isIOS && !isStandalone) {
                setTimeout(() => {
                    const banner = document.querySelector('.install-banner');
                    if (banner) banner.classList.add('show');
                }, 3000);
            }
        }

        // Render app
        function render() {
            const section = sections[currentTab];
            let html = `
                <div class="header">
                    <h1>üõ°Ô∏è Security Assessment Pro</h1>
                    <p>Professional Evaluation Tool</p>
                    
                    <div class="install-banner">
                        <strong>üì± Install this app:</strong>
                        Tap Share (‚¨ÜÔ∏è) ‚Üí "Add to Home Screen" ‚Üí Works offline!
                    </div>
                    
                    <div class="progress-wrapper">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressBar"></div>
                        </div>
                        <div class="progress-text" id="progressText">0% Complete</div>
                    </div>
                </div>

                <div class="tabs">
                    ${Object.keys(sections).map(key => `
                        <span class="tab ${currentTab === key ? 'active' : ''}" 
                              onclick="changeTab('${key}')">
                            ${sections[key].title}
                        </span>
                    `).join('')}
                </div>

                <div class="content">
                    <div class="section-title">${section.title}</div>
                    <div class="section-desc">${section.desc}</div>
            `;

            if (section.fields) {
                section.fields.forEach(field => {
                    const val = data[field.id] || '';
                    html += `
                        <div class="form-group">
                            <label class="label">${field.label}</label>
                            ${field.type === 'select' ? `
                                <select onchange="save('${field.id}', this.value)">
                                    <option value="">Select...</option>
                                    ${field.options.map(o => 
                                        `<option value="${o}" ${val === o ? 'selected' : ''}>${o}</option>`
                                    ).join('')}
                                </select>
                            ` : field.type === 'textarea' ? `
                                <textarea onchange="save('${field.id}', this.value)">${val}</textarea>
                            ` : `
                                <input type="text" value="${val}" 
                                       onchange="save('${field.id}', this.value)"
                                       placeholder="Enter ${field.label.toLowerCase()}">
                            `}
                        </div>
                    `;
                });
            } else if (section.items) {
                section.items.forEach(item => {
                    const d = data[item.id] || {};
                    html += `
                        <div class="card">
                            <div class="question">${item.q}</div>
                            <div class="toggle-btns">
                                <button class="toggle-btn yes ${d.v === 'yes' ? 'active' : ''}"
                                        onclick="toggle('${item.id}', 'yes')">
                                    ‚úì YES
                                </button>
                                <button class="toggle-btn partial ${d.v === 'partial' ? 'active' : ''}"
                                        onclick="toggle('${item.id}', 'partial')">
                                    ‚óê PARTIAL
                                </button>
                                <button class="toggle-btn no ${d.v === 'no' ? 'active' : ''}"
                                        onclick="toggle('${item.id}', 'no')">
                                    ‚úó NO
                                </button>
                            </div>
                            ${Object.keys(item.r).map(k => {
                                const rec = item.r[k];
                                return `
                                    <div class="rec ${d.v === k ? 'show' : ''}" id="rec-${item.id}-${k}">
                                        <div class="badge badge-${rec.s}">${rec.s.toUpperCase()}</div>
                                        <div>${rec.t}</div>
                                    </div>
                                `;
                            }).join('')}
                            <textarea class="notes" placeholder="Additional notes, observations, or client-specific details..."
                                      onchange="saveNote('${item.id}', this.value)">${d.n || ''}</textarea>
                        </div>
                    `;
                });
            }

            html += `
                </div>
                <div class="bottom-bar">
                    <div class="stats">
                        <div class="stat">
                            <div class="stat-value" id="statDone">0</div>
                            <div class="stat-label">Done</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="statCritical">0</div>
                            <div class="stat-label">Critical</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="statIssues">0</div>
                            <div class="stat-label">Issues</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="statTotal">0</div>
                            <div class="stat-label">Total</div>
                        </div>
                    </div>
                    <div class="btn-row">
                        <button class="btn btn-secondary" onclick="clearData()">
                            üóëÔ∏è Clear
                        </button>
                        <button class="btn btn-primary" onclick="generate()">
                            üìÑ Report
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('app').innerHTML = html;
        }

        // Change tab
        function changeTab(tab) {
            currentTab = tab;
            render();
            updateStats();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Save field data
        function save(id, val) {
            data[id] = val;
            localStorage.setItem('securityAssessment', JSON.stringify(data));
            updateStats();
            showToast('üíæ Saved');
        }

        // Toggle assessment item
        function toggle(id, val) {
            if (!data[id]) data[id] = {};
            data[id].v = val;
            localStorage.setItem('securityAssessment', JSON.stringify(data));
            
            // Update UI
            document.querySelectorAll(`[onclick*="toggle('${id}"]`).forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[onclick="toggle('${id}', '${val}')"]`).classList.add('active');
            
            document.querySelectorAll(`[id^="rec-${id}-"]`).forEach(rec => {
                rec.classList.remove('show');
            });
            const recEl = document.getElementById(`rec-${id}-${val}`);
            if (recEl) recEl.classList.add('show');
            
            updateStats();
            showToast('üíæ Saved');
        }

        // Save notes
        function saveNote(id, note) {
            if (!data[id]) data[id] = {};
            data[id].n = note;
            localStorage.setItem('securityAssessment', JSON.stringify(data));
            showToast('üíæ Note saved');
        }

        // Update statistics
        function updateStats() {
            let total = 0;
            let done = 0;
            let critical = 0;
            let issues = 0;

            Object.values(sections).forEach(sec => {
                if (sec.fields) {
                    total += sec.fields.length;
                } else if (sec.items) {
                    total += sec.items.length;
                    sec.items.forEach(item => {
                        if (data[item.id]?.v) {
                            if (data[item.id].v === 'no' && item.r.no.s === 'critical') {
                                critical++;
                            }
                            if (data[item.id].v !== 'yes') {
                                issues++;
                            }
                        }
                    });
                }
            });

            done = Object.keys(data).filter(k => data[k]?.v || (typeof data[k] === 'string' && data[k])).length;
            const pct = Math.round((done / total) * 100);

            const bar = document.getElementById('progressBar');
            const text = document.getElementById('progressText');
            const statDone = document.getElementById('statDone');
            const statCritical = document.getElementById('statCritical');
            const statIssues = document.getElementById('statIssues');
            const statTotal = document.getElementById('statTotal');

            if (bar) bar.style.width = pct + '%';
            if (text) text.textContent = pct + '% Complete (' + done + '/' + total + ')';
            if (statDone) statDone.textContent = done;
            if (statCritical) statCritical.textContent = critical;
            if (statIssues) statIssues.textContent = issues;
            if (statTotal) statTotal.textContent = total;
        }

        // Generate report
        function generate() {
            let report = '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
            report += 'RESIDENTIAL SECURITY ASSESSMENT REPORT\n';
            report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
            
            report += 'PROPERTY INFORMATION:\n';
            report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
            report += `Property: ${data.propName || 'N/A'}\n`;
            report += `Address: ${data.address || 'N/A'}\n`;
            report += `Square Footage: ${data.sqft || 'N/A'}\n`;
            report += `Threat Level: ${data.threat || 'N/A'}\n\n`;

            let findings = [];
            Object.values(sections).forEach(sec => {
                if (sec.items) {
                    sec.items.forEach(item => {
                        const d = data[item.id];
                        if (d?.v) {
                            findings.push({
                                section: sec.title,
                                q: item.q,
                                v: d.v,
                                r: item.r[d.v],
                                n: d.n
                            });
                        }
                    });
                }
            });

            const critical = findings.filter(f => f.r.s === 'critical');
            const important = findings.filter(f => f.r.s === 'important');
            const good = findings.filter(f => f.r.s === 'good');

            report += 'ASSESSMENT SUMMARY:\n';
            report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
            report += `Total Items Assessed: ${findings.length}\n`;
            report += `Critical Issues: ${critical.length}\n`;
            report += `Important Issues: ${important.length}\n`;
            report += `Good Ratings: ${good.length}\n\n`;

            if (critical.length > 0) {
                report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
                report += 'CRITICAL FINDINGS - IMMEDIATE ACTION\n';
                report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
                critical.forEach((f, i) => {
                    report += `${i+1}. ${f.q}\n`;
                    report += `   Status: ${f.v.toUpperCase()}\n`;
                    report += `   ${f.r.t}\n`;
                    if (f.n) report += `   Notes: ${f.n}\n`;
                    report += '\n';
                });
            }

            if (important.length > 0) {
                report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
                report += 'IMPORTANT FINDINGS - PRIORITY UPGRADE\n';
                report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
                important.forEach((f, i) => {
                    report += `${i+1}. ${f.q}\n`;
                    report += `   Status: ${f.v.toUpperCase()}\n`;
                    report += `   ${f.r.t}\n`;
                    if (f.n) report += `   Notes: ${f.n}\n`;
                    report += '\n';
                });
            }

            report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
            report += 'END OF REPORT\n';
            report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';

            // Copy to clipboard and show alert
            navigator.clipboard.writeText(report).then(() => {
                alert('‚úÖ Report Generated!\n\nReport has been copied to your clipboard.\n\nYou can paste it into:\n‚Ä¢ Notes app\n‚Ä¢ Email\n‚Ä¢ Messages\n‚Ä¢ Any document\n\nPress and hold, then tap "Paste"');
            }).catch(() => {
                alert('üìÑ Report Generated!\n\n' + report.substring(0, 500) + '\n\n... [Full report in browser console]');
                console.log(report);
            });
        }

        // Clear all data
        function clearData() {
            if (confirm('‚ö†Ô∏è Clear all assessment data?\n\nThis cannot be undone.')) {
                localStorage.removeItem('securityAssessment');
                data = {};
                render();
                updateStats();
                showToast('üóëÔ∏è Data cleared');
            }
        }

        // Show toast notification
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }

        // Initialize on load
        window.onload = init;
    </script>
</body>
</html>
